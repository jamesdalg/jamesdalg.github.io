---
title: "NY NOAA data"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(p8105.datasets)
library(plotly)
#use below to render
#rmarkdown::render("noaa_flexdash.Rmd",output_format = "flex_dashboard")
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}
noaa <- p8105.datasets::ny_noaa %>% 
  as.tibble() %>% 
  janitor::clean_names()

noaa_clean <- p8105.datasets::ny_noaa %>% #Pull in the data.
  as.tibble() %>%  #convert to tibble format.
  janitor::clean_names() %>%  #convert to snake case.
mutate(day = lubridate::day(noaa$date), #create day, month, and year variables.
       month = lubridate::month(noaa$date),
       year = lubridate::year(noaa$date),
       tmax = as.numeric(tmax)/10, #convert tmax and tmin to numeric type and correct to comparable units of degrees celcius (rather than tenths of degrees)
       tmin = as.numeric(tmin)/10,
       prcp = as.numeric(prcp)/10, #corrects the precipitation to be in milimeters rather than tenths of a mililiter
       snow = as.numeric(snow),
       snwd = as.numeric(snwd),
        snow_rank = snow %>% 
            as.numeric() %>% 
             rank(),
        snwd_rank = snwd %>% 
            as.numeric() %>% 
             rank()
       )

noaa_latlng <- inner_join(noaa_clean, stations, by = "id") %>% 
    na.omit() %>% 
  select(names(noaa_clean),"latitude","longitude","elevation") %>%
  group_by(year) %>%
  sample_n(50) 
remove_bg <- list( zeroline = FALSE, showline = FALSE, showticklabels = FALSE,
  title = "", showgrid = FALSE)

ternary_plot <- noaa_latlng  %>% 
  plot_ly() %>%
  add_trace(
    type = 'scatterternary',
    mode = 'markers',
    a = ~snow, b = ~snwd, c = ~elevation,text = ~tmax, color = ~latitude
  ) %>%
  layout(
    title = "Geolocation, Altitude, and Precipitation in New York",
    ternary = list(
      sum = 100,
      aaxis = list(title = 'Snowfall'),
      baxis = list(title = 'Snowdepth'),
      caxis = list(title = 'Elevation')
    ),
    xaxis = remove_bg, yaxis = remove_bg
  )
ternary_plot
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}
set.seed(1)
s <- subplot(
  plot_ly(data = noaa_clean %>%
            na.omit() %>%
#            filter(snwd < 2e3 & snow < 2e3) %>%
            sample_n(50),
          x = ~snow, type = "violin", side = "positive"),
  plotly_empty(),
  plot_ly(data = noaa_clean %>% 
            na.omit() %>% 
#            filter(snwd < 2e3 & snow < 2e3) %>%
            sample_n(50),
          x = ~snow, y = ~snwd, z = ~tmax, type = "contour"),
  plot_ly(data = noaa_clean %>% 
            na.omit() %>% 
#            filter(snwd < 2e3 & snow < 2e3) %>%
            sample_n(50),
          y = ~snwd, type = "violin", side = "positive"),
  nrows = 2, heights = c(0.2, 0.8), widths = c(0.8, 0.2), margin = 0,
  shareX = TRUE, shareY = TRUE, titleX = FALSE, titleY = FALSE
)
p <- layout(s, showlegend = FALSE)
p
```

### Chart C

```{r, cache = F}
#The below code was used to pull NOAA data with latitude and longitude.
stations <- rnoaa::ghcnd_stations() #Grabs station ids
noaa_latlng <- inner_join(noaa_clean, stations, by = "id") %>% 
  select(names(noaa_clean),"latitude","longitude","elevation") %>%
  group_by(year) %>%
  sample_n(50)
  #plot_ly(x = ~longitude, y = ~latitude, z = ~elevation, type = "contour")
Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiamxkMjIyNyIsImEiOiJjam55d2dmMHoxOXZqM3FrZ2VlbzQxYml2In0.CjBx2QOmKnCjhlh_l4edvA')
ny_county_data <- map_data('county') %>%
  filter(region == "new york") %>%
  group_by(group)  
plotly::plot_ly(data = ny_county_data, x = ~long, y = ~lat, fillcolor = 'white',
                hoverinfo = "none") %>% 
add_polygons(size = I(2)) %>% 
  add_markers(data = noaa_latlng, x = ~longitude, y = ~latitude, color = ~snwd) %>% 
  toWebGL()
```

