---
title: "NY NOAA data"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(p8105.datasets)
library(plotly)
```

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}
noaa <- p8105.datasets::ny_noaa %>% 
  as.tibble() %>% 
  janitor::clean_names()

noaa_clean <- p8105.datasets::ny_noaa %>% #Pull in the data.
  as.tibble() %>%  #convert to tibble format.
  janitor::clean_names() %>%  #convert to snake case.
mutate(day = lubridate::day(noaa$date), #create day, month, and year variables.
       month = lubridate::month(noaa$date),
       year = lubridate::year(noaa$date),
       tmax = as.numeric(tmax)/10, #convert tmax and tmin to numeric type and correct to comparable units of degrees celcius (rather than tenths of degrees)
       tmin = as.numeric(tmin)/10,
       prcp = as.numeric(prcp)/10, #corrects the precipitation to be in milimeters rather than tenths of a mililiter
       snow = as.numeric(snow),
       snwd = as.numeric(snwd),
        snow_rcp = snow %>% 
            as.numeric() %>% 
             (function(x){1 - 1/x}) )
tmaxmin_hex <- noaa_clean %>% 
  ggplot(aes(y = tmax, x = tmin)) + geom_hex() +
  labs(y = "Max temperature, in Degrees C", x = "Minimum Temperature In Degrees C")

snow_year_dist <- noaa_clean %>% 
  filter(year %in% c(2010,2009)) %>% 
group_by(year) %>%
  sample_n(500) %>% 
plot_ly(data = ., type = "violin", x = ~year, y = ~snow_rcp) %>% 
  # add_trace(y = ~snow, x = ~year,  side = "negative") %>% #
  # add_trace(y = ~snwd, x = ~year, side = "positive") %>% # x = ~month, 
  layout(
    yaxis = list(type = "log"),
    violingap = 0,
    violingroupgap = 0
  )
  df <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/violin_data.csv")

p <- noaa_clean %>%
    filter(snow != 0) %>% 
  group_by(year) %>%
  sample_n(500) %>% 
  plot_ly(type = 'violin') %>%
  add_trace(
    x = ~year,
    y = ~snow,
    legendgroup = 'Snowfall (mm)',
    scalegroup = 'Snowfall (mm)',
    name = 'Snowfall (mm)',
    side = 'negative',
    box = list(
      visible = T
    ),
    meanline = list(
      visible = T
    ),
    line = list(
      color = 'blue'
    )
  ) %>%
  add_trace(
    x = ~year,
    y = ~snwd,
    legendgroup = 'Snow depth (mm)',
    scalegroup = 'Snow depth (mm)',
    name = 'Snow depth (mm)',
    side = 'positive',
    box = list(
      visible = T
    ),
    meanline = list(
      visible = T
    ),
    line = list(
      color = 'green'
    )
  ) %>% 
  layout(
    xaxis = list(
      title = ""  
    ),
    yaxis = list(
      title = "",
      zeroline = F
    ),
    violingap = 0,
    violingroupgap = 0,
    violinmode = 'overlay'
  )
  #, color = ~snow, fill = ~snow 
#  add_markers(alpha = 0.2) %>%
#  toWebGL()
#   filter(snow > 0 & snow < 100) %>%
#     ggplot(aes(x = snow,y = year,color=snow,fill = snow)) +
#   geom_density_ridges_gradient(scale = 0.85,gradient_lwd = .1,
#                                aes(x = snow,y = as.factor(year),fill = snow)) +
#   scale_color_viridis_c() +
#     scale_fill_viridis_c() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1))
# plotly::ggplotly(tmaxmin_hex) %>% toWebGL()

```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}
set.seed(1)
s <- subplot(
  plot_ly(data = noaa_clean %>% na.omit(),
          x = ~snow, type = "violin", side = "positive"),
  plotly_empty(),
  plot_ly(data = noaa_clean %>% na.omit(),
          x = ~snow, y = ~snwd, z = ~tmax, type = "contour"),
  plot_ly(data = noaa_clean %>% na.omit(),
          y = ~snwd, type = "violin", side = "positive"),
  nrows = 2, heights = c(0.2, 0.8), widths = c(0.8, 0.2), margin = 0,
  shareX = TRUE, shareY = TRUE, titleX = FALSE, titleY = FALSE
) %>% toWebGL()
p <- layout(s, showlegend = FALSE)
```

### Chart C

```{r, cache = T}
#The below code was used to pull NOAA data with latitude and longitude.
stations <- rnoaa::ghcnd_stations() #Grabs station ids
nc <- sf::st_read(system.file("shape/ny.shp", package = "sf"), quiet = TRUE) #grabs ny map
noaa_latlng <- inner_join(noaa_clean, stations, by = "id") %>% 
  select(names(noaa_clean),"latitude","longitude","elevation") %>%
  group_by(year) %>%
  sample_n(50)
  #plot_ly(x = ~longitude, y = ~latitude, z = ~elevation, type = "contour")
Sys.setenv('MAPBOX_TOKEN' = 'pk.eyJ1IjoiamxkMjIyNyIsImEiOiJjam55d2dmMHoxOXZqM3FrZ2VlbzQxYml2In0.CjBx2QOmKnCjhlh_l4edvA')
ny_county_data <- map_data('county') %>%
  filter(region == "new york") %>%
  group_by(group)  
plotly::plot_ly(data = ny_county_data, x = ~long, y = ~lat, fillcolor = 'white',
                hoverinfo = "none") %>% 
add_polygons(size = I(2)) %>% 
  add_markers(data = noaa_latlng, x = ~longitude, y = ~latitude, color = ~snwd)# %>% 
#  toWebGL()
```

